<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Solocendence">
    <meta name="theme-color" content="#000000">
    
    <title>Solocendence - Classic Arcade with a Modern Twist</title>
    
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="privacy-policy.css">
    <link rel="stylesheet" href="dashboard-styles.css">
</head>
<body>
    <!-- Main Application Container -->
    <main id="app" class="container-fluid p-0">
        <!-- Language Selection Page -->
        <section id="language-page" class="page active">
            <h2 class="text-center" data-i18n="selectLanguage">Select Language</h2>
            <select id="language-selector" class="button form-select mb-3">
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
            </select>
            <button id="next-button" class="button btn btn-primary w-100" data-i18n="next">Next</button>
        </section>

        <!-- Updated Game Page with consolidated buttons -->
        <section id="game-page" class="page">
            <h2 id="enter-name" class="text-center" data-i18n="enterName">Enter Your Nickname</h2>
            
            <!-- Game Setup Form -->
            <div class="mb-3">
                <input type="text" id="nickname" class="nickname-input form-control" placeholder="Enter a cool name" autocomplete="off" maxlength="16">
            </div>
            
            <div class="mb-3">
                <input type="number" id="rounds-input" class="rounds-input form-control" placeholder="Enter rounds" value="3" min="1" max="20">
            </div>

            <!-- Game Mode Selector -->
            <div class="queue-wrapper d-flex align-items-center justify-content-center">
                <i id="prevMode" class="fa fa-caret-left" aria-hidden="true"></i>
                <button id="start-game" class="button join-game-button hidden">
                    <div class="button-text" data-i18n="joinGame">JOIN GAME</div>
                    <div class="game-mode-indicator">Classic with queue</div>
                </button>
                <i id="nextMode" class="fa fa-caret-right" aria-hidden="true"></i>
            </div>

            <!-- Waiting Players Section -->
            <div id="waiting-players-container" class="card bg-transparent mt-3">
                <div class="card-body">
                    <h3 class="card-title h5 mb-2">Currently Waiting Players <small class="text-muted">(click to join)</small></h3>
                    <ul id="waiting-players-list" class="list-group list-group-flush bg-transparent"></ul>
                </div>
            </div>
            
            <!-- Bottom Navigation Buttons - Only keep these two -->
            <button id="leaderboard-button" data-navigate="leaderboard-page" class="button btn btn-secondary secondary mt-3 w-100" data-i18n="leaderboard">Leaderboard</button>
            
            <button id="privacy-policy-button" data-navigate="privacy-policy-page" class="button btn btn-secondary mt-2 w-100">Privacy Policy / GDPR</button>
        </section>

        <!-- Create a new tournament page that will be navigated to when selecting tournament mode -->
        <section id="tournament-page" class="page">
            <h2 class="text-center">Tournament Mode</h2>
            
            <!-- Tournament creation section -->
            <div class="card bg-transparent mb-3">
                <div class="card-body">
                  <h4 class="card-title">Create or Join Tournament</h4>
                  <p class="card-text">Create your own tournament or join an existing one.</p>
                  
                  <button id="create-tournament" class="button btn btn-primary w-100 mb-2">Create Tournament</button>
                  <button id="recover-tournament" class="button btn btn-warning w-100">Rejoin My Tournament</button>
                </div>
            </div>
            
            <!-- Tournament info (when in a tournament) -->
            <div id="active-tournament" class="card bg-transparent mt-3" style="display: none;">
                <div class="card-body">
                    <h4 class="card-title">Tournament: <span id="tournament-name">-</span></h4>
                    <div class="tournament-controls mb-3">
                        <!-- Only tournament creator sees this -->
                        <button id="start-tournament" class="btn btn-success btn-lg w-100 mb-2" style="display: none;">
                            <i class="fa fa-play-circle"></i> Start Tournament
                        </button>
                        <button id="leave-tournament" class="btn btn-danger">
                            <i class="fa fa-sign-out"></i> Leave Tournament
                        </button>
                    </div>
                    
                    <h5>Players</h5>
                    <ul id="tournament-players" class="list-group list-group-flush mb-3"></ul>
                    
                    <div id="tournament-matches">
                        <h5>Current Match</h5>
                        <div id="current-match" class="card bg-dark mb-3 p-2 text-center">No active match</div>
                        
                        <h5>Upcoming Matches</h5>
                        <ul id="upcoming-matches" class="list-group list-group-flush mb-3"></ul>
                        
                        <h5>Completed Matches</h5>
                        <ul id="completed-matches" class="list-group list-group-flush"></ul>
                    </div>
        
                    <div id="tournament-ready-section" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                          <p><strong>Ready for your next match?</strong></p>
                          <p>Click the button below when you're ready to play your next match.</p>
                          <button id="ready-for-match" class="btn btn-success w-100">
                            <i class="fa fa-check-circle"></i> I'm Ready for My Next Match
                          </button>
                        </div>
                    </div>
        
                    <div id="tournament-status-notification" class="alert alert-primary mt-3" style="display: none;">
                        <span id="tournament-status-message">Waiting for other players to be ready...</span>
                    </div>
                </div>
            </div>
            
            <!-- Available tournaments list -->
            <div id="available-tournaments" class="card bg-transparent mt-3">
                <div class="card-body">
                    <h4 class="card-title">Available Tournaments</h4>
                    <ul id="tournament-list" class="list-group list-group-flush">
                        <li class="list-group-item">No tournaments available</li>
                    </ul>
                </div>
            </div>
            
            <!-- Tournament Leave Warning -->
            <div id="tournament-leave-warning" class="exit-warning mt-3" style="display: none;">
                <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                WARNING: Leaving this page will remove you from the current tournament!
            </div>
            
            <button id="tournament-debug-start" class="btn btn-sm btn-dark mt-2 w-100" style="display: none;">
                Debug: Force Start Tournament
            </button>

            <!-- Back Button -->
            <button id="tournament-back-button" data-navigate="game-page" class="button btn btn-secondary mt-3 w-100">Back to Menu</button>
        
            <!-- Add a debugging button to help during development (can be removed in production) -->
        </section>

        <!-- Custom Game Page -->
        <section id="custom-game-page" class="page">
            <h2 class="text-center">Custom Game</h2>
            
            <!-- Code input section -->
            <div class="code-input-section mb-3">
                <label for="game-code" class="form-label">Game Code</label>
                <div class="input-group">
                    <input type="text" id="game-code" class="form-control" placeholder="Enter special code..." maxlength="10">
                    <button id="apply-code" class="btn btn-primary">Apply</button>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <button id="generate-code" class="btn btn-sm btn-info">Generate Code</button>
                    <button id="copy-code" class="btn btn-sm btn-secondary">Copy to Clipboard</button>
                </div>
            </div>
            
            <!-- Presets -->
            <div class="preset-section mb-3">
                <label class="form-label">Quick Presets</label>
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="preset-button btn btn-sm btn-outline-danger" data-preset="speed">Speedemon</button>
                    <button class="preset-button btn btn-sm btn-outline-info" data-preset="retro">Retro</button>
                    <button class="preset-button btn btn-sm btn-outline-warning" data-preset="giant">Giant Paddles</button>
                    <button class="preset-button btn btn-sm btn-outline-success" data-preset="micro">Micro Mode</button>
                    <button class="preset-button btn btn-sm btn-outline-primary" data-preset="chaos">Chaos</button>
                </div>
            </div>
            
            <!-- Customization Options -->
            <div class="customization-section">
                <!-- Ball Speed -->
                <div class="option-row mb-3">
                    <label for="ball-speed" class="form-label">Ball Speed: <span id="ball-speed-value">4</span></label>
                    <input type="range" class="form-range" id="ball-speed" min="2" max="10" step="0.5" value="4">
                </div>
                
                <!-- Paddle Size -->
                <div class="option-row mb-3">
                    <label for="paddle-size" class="form-label">Paddle Size: <span id="paddle-size-value">100%</span></label>
                    <input type="range" class="form-range" id="paddle-size" min="50" max="200" step="10" value="100">
                </div>
                
                <!-- Speed Increment -->
                <div class="option-row mb-3">
                    <label for="speed-increment" class="form-label">Speed Increment: <span id="speed-increment-value">0.5</span></label>
                    <input type="range" class="form-range" id="speed-increment" min="0" max="2" step="0.1" value="0.5">
                </div>
                
                <!-- Colors -->
                <div class="row mb-3">
                    <div class="col">
                        <label for="ball-color" class="form-label">Ball Color</label>
                        <input type="color" class="form-control form-control-color" id="ball-color" value="#00d4ff">
                    </div>
                    <div class="col">
                        <label for="left-paddle-color" class="form-label">Left Paddle</label>
                        <input type="color" class="form-control form-control-color" id="left-paddle-color" value="#007bff">
                    </div>
                    <div class="col">
                        <label for="right-paddle-color" class="form-label">Right Paddle</label>
                        <input type="color" class="form-control form-control-color" id="right-paddle-color" value="#ff758c">
                    </div>
                </div>
                
                <!-- Physics Options -->
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="gravity-enabled">
                    <label class="form-check-label" for="gravity-enabled">
                        Enable Gravity Effect
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="bounce-random">
                    <label class="form-check-label" for="bounce-random">
                        Random Bounce Angles
                    </label>
                </div>
            </div>
            
            <!-- Start Game Button -->
            <button id="start-custom-game" class="button btn btn-primary w-100 mt-3">Start Custom Game</button>
            
            <!-- Back Button -->
            <button id="back-to-menu" data-navigate="game-page" class="button btn btn-secondary mt-2 w-100">Back to Menu</button>
        </section>

        <!-- Pong Game Page -->
        <section id="pong-page" class="page">
            <!-- Game Overlay for Fullscreen Info -->
            <div id="game-overlay" class="position-absolute">
                <div id="overlay-player-name" class="text-center"></div>
                <div id="overlay-score" class="text-center"></div>
            </div>
            
            <!-- Mini info display for when game is minimized -->
            <div id="game-info" class="game-info">
                <span id="player-name"></span> | Rounds: <span id="player-rounds">0</span> / <span id="target-rounds">0</span>
            </div>
            
            <canvas id="pong-canvas" class="w-100"></canvas>

            <div class="d-flex justify-content-between mt-3">
                <button id="end-game" class="button btn btn-secondary secondary hidden">Leave Game</button>
                <!-- Hidden debug button for testing -->
                <button id="debug-join" class="button btn btn-dark debug hidden">DEBUG JOIN</button>
            </div>
            <h3 id="pong-status" class="message text-center mt-3" data-i18n="waitingOpponent">Waiting for an opponent...</h3>
        </section>

        <!-- Leaderboard Page -->
        <section id="leaderboard-page" class="page">
            <h2 class="text-center" data-i18n="leaderboard">Leaderboard</h2>
            <div class="card bg-transparent mb-3">
                <div class="card-body p-0">
                    <ul id="leaderboard" class="leaderboard-list list-group list-group-flush"></ul>
                </div>
            </div>
            <button id="back-button" data-navigate="game-page" class="button btn btn-secondary secondary w-100" data-i18n="back">Back</button>
        </section>
        
        <!-- Privacy Policy Page -->
        <section id="privacy-policy-page" class="page">
            <h2 class="text-center" data-i18n="privacyPolicy">Privacy Policy</h2>
            
            <div class="privacy-content">
                <div class="privacy-section mb-3">
                    <h3>What Data We Collect</h3>
                    <p>
                        We collect minimal data necessary to provide the Pong game service:
                    </p>
                    <ul>
                        <li>Nickname (publicly visible)</li>
                        <li>Game statistics (wins, losses, total games)</li>
                        <li>Temporary session data</li>
                    </ul>
                </div>
                
                <div class="privacy-section mb-3">
                    <h3>How We Use Your Data</h3>
                    <p>
                        Your data is used solely to:
                    </p>
                    <ul>
                        <li>Display game statistics on leaderboards</li>
                        <li>Track game history and performance</li>
                        <li>Improve the game experience</li>
                    </ul>
                    <p>
                        We do not sell or share your data with third parties.
                    </p>
                </div>
                
                <div class="privacy-section mb-3">
                    <h3>Your Rights</h3>
                    <p>
                        Under GDPR, you have the right to:
                    </p>
                    <ul>
                        <li>Access your personal data</li>
                        <li>Correct inaccurate data</li>
                        <li>Delete your data ("right to be forgotten")</li>
                    </ul>
                </div>
                
                <div class="privacy-section mb-3">
                    <h3>Delete Your Data</h3>
                    <p>
                        To delete all your game data, please enter your nickname below. This action cannot be undone.
                    </p>
                    
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will permanently delete all your game statistics and records.
                    </div>
                    
                    <div class="delete-data-form mb-3">
                        <div class="mb-3">
                            <label for="delete-nickname" class="form-label">Your Nickname:</label>
                            <input type="text" id="delete-nickname" class="form-control" placeholder="Enter nickname" maxlength="16">
                        </div>
                        
                        <button id="generate-verification" class="btn btn-warning mb-3">Generate Verification Code</button>
                        
                        <div id="verification-section" class="mb-3" style="display: none;">
                            <div class="verification-instructions alert alert-info">
                                <p>To confirm your identity, please enter the following verification code:</p>
                                <div id="verification-code" class="verification-code"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="verification-input" class="form-label">Verification Code:</label>
                                <input type="text" id="verification-input" class="form-control" placeholder="Enter verification code">
                            </div>
                            
                            <button id="confirm-delete" class="btn btn-danger">Delete My Data</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="delete-result" class="alert" style="display: none;"></div>
            
            <button id="privacy-back-button" data-navigate="game-page" class="button btn btn-secondary secondary w-100" data-i18n="back">Back</button>
        </section>
    </main>

    <!-- Background Animation Canvas -->
    <canvas id="background-pong" class="background-canvas"></canvas>
    
    <!-- Toast Container for Notifications -->
    <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Utility Scripts -->
    <script src="js/tournament-warning.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/services.js"></script>
    
    <!-- Core Modules -->
    <script src="js/localization.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/websocket.js"></script>
    
    <!-- Game Modules -->
    <script src="js/server-pong-renderer.js"></script> <!-- Add new server pong renderer -->
    <script src="js/pong-game.js"></script>  <!-- Keep for AI/Custom games -->
    <script src="js/custom-game-manager.js"></script>
    <script src="js/tournament-manager.js"></script>
    <!-- Tournament Bracket System -->
    <script src="js/tournament-bracket.js"></script>
    
    <!-- Feature Modules -->
    <script src="js/player-stats-dashboard.js"></script>
    <script src="js/gdpr-manager.js"></script>
    <script src="js/background-pong.js"></script>
    
    <!-- Optional Mobile Support -->
    <script src="js/mobile-joystick.js"></script>

    <!-- Background Pong Script -->
    <script src="js/easter-egg.js"></script>

    <script src="js/tournament-debug.js"></script>

    <!-- Main Application Script (Load Last) -->
    <script src="js/main.js"></script>

    <button id="tournament-debug-start" class="btn btn-sm btn-dark mt-2 w-100" style="display: none;">
        Debug: Force Start Tournament
    </button>
    
    <!-- Add this script just before the closing </body> tag -->
    <script>
        // Simple tournament button fixer script
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Tournament button fixer script running");
            
            // Try to make start button visible for tournament creator
            function checkAndFixStartButton() {
                const startBtn = document.getElementById('start-tournament');
                if (!startBtn) return;
                
                let isCreator = false;
                try {
                    isCreator = localStorage.getItem('isTournamentCreator') === 'true';
                } catch (e) { }
                
                console.log("Button fixer - Creator status:", isCreator);
                
                if (isCreator) {
                    console.log("Making start button visible from fixer script");
                    startBtn.style.display = 'block';
                    
                    // Ensure click handler
                    if (!startBtn._hasClickHandler) {
                        startBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Get tournament ID
                            let tournamentId = null;
                            try {
                                tournamentId = localStorage.getItem('activeTournamentId');
                            } catch (e) { }
                            
                            if (tournamentId && window.WebSocketManager) {
                                console.log("Sending start tournament from fixer");
                                WebSocketManager.send({
                                    type: "start_tournament",
                                    tournament_id: tournamentId
                                });
                                
                                // Visual feedback
                                startBtn.disabled = true;
                                startBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Starting...';
                                
                                // Re-enable after timeout
                                setTimeout(() => {
                                    startBtn.disabled = false;
                                    startBtn.innerHTML = '<i class="fa fa-play-circle"></i> Start Tournament';
                                }, 3000);
                            }
                        });
                        startBtn._hasClickHandler = true;
                    }
                }
            }
            
            // Setup debug button
            const debugBtn = document.getElementById('tournament-debug-start');
            if (debugBtn) {
                debugBtn.addEventListener('click', function() {
                    console.log("Debug start button clicked");
                    
                    // Force creator status to true
                    try {
                        localStorage.setItem('isTournamentCreator', 'true');
                    } catch (e) { }
                    
                    // Get tournament ID
                    let tournamentId = null;
                    try {
                        tournamentId = localStorage.getItem('activeTournamentId');
                    } catch (e) { }
                    
                    // Try to send start command
                    if (tournamentId && window.WebSocketManager) {
                        WebSocketManager.send({
                            type: "start_tournament",
                            tournament_id: tournamentId
                        });
                        
                        alert("Debug: Start tournament command sent for ID: " + tournamentId);
                    } else {
                        alert("Cannot start: No tournament ID or WebSocket connection");
                    }
                    
                    // Immediately check and fix the start button
                    checkAndFixStartButton();
                });
                
                // Show debug button in development or with URL param
                if (window.location.search.includes('debug=1') || 
                    window.location.hostname === 'localhost') {
                    debugBtn.style.display = 'block';
                }
            }
            
            // Run button check when tournament page is shown
            const tournamentPage = document.getElementById('tournament-page');
            if (tournamentPage) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.target.id === 'tournament-page' && 
                            mutation.target.classList.contains('active')) {
                            setTimeout(checkAndFixStartButton, 100);
                        }
                    });
                });
                
                observer.observe(tournamentPage, { attributes: true, attributeFilter: ['class'] });
            }
            
            // Run on start to check button status
            setTimeout(checkAndFixStartButton, 500);
        });
    </script>
    <script>
        // Direct fix for Create Tournament button
        document.addEventListener('DOMContentLoaded', function() {
          console.log("Create tournament button fix running");
          
          // Target the specific button
          const createTournamentBtn = document.getElementById('create-tournament');
          if (createTournamentBtn) {
            console.log("Found the create tournament button, adding direct event listener");
            
            // Remove any existing listeners by cloning the button
            const newBtn = createTournamentBtn.cloneNode(true);
            if (createTournamentBtn.parentNode) {
              createTournamentBtn.parentNode.replaceChild(newBtn, createTournamentBtn);
            }
            
            // Add the direct click handler
            newBtn.addEventListener('click', function(e) {
              e.preventDefault();
              console.log("Create tournament button clicked directly");
              
              // Get the nickname
              const nicknameInput = document.getElementById('nickname');
              if (!nicknameInput || !nicknameInput.value.trim()) {
                alert("Please enter your nickname first");
                return;
              }
              
              const nickname = nicknameInput.value.trim();
              
              // Get rounds
              const roundsInput = document.getElementById('rounds-input');
              const rounds = roundsInput ? parseInt(roundsInput.value) || 3 : 3;
              
              // Create a tournament name
              const tournamentName = `${nickname}'s Tournament`;
              
              console.log(`Creating tournament: ${tournamentName} by ${nickname} with ${rounds} rounds`);
              
              // Send the create tournament message directly
              if (window.WebSocketManager && WebSocketManager.isConnected && WebSocketManager.isConnected()) {
                WebSocketManager.send({
                  type: "create_tournament",
                  nickname: nickname,
                  name: tournamentName,
                  rounds: rounds
                });
                
                // Show visual feedback
                newBtn.disabled = true;
                newBtn.innerText = "Creating...";
                
                // Re-enable after timeout
                setTimeout(() => {
                  newBtn.disabled = false;
                  newBtn.innerText = "Create Tournament";
                }, 3000);
                
                // Show toast if available
                if (window.Utils && Utils.showToast) {
                  Utils.showToast("Creating tournament...", "info");
                }
              } else {
                alert("Cannot create tournament: Not connected to server");
              }
            });
            
            console.log("Direct event listener added to create tournament button");
          } else {
            console.error("Create tournament button not found in DOM");
          }
          
          // Also make sure the TournamentManager is initialized
          if (window.TournamentManager && typeof TournamentManager.init === 'function') {
            // Get any existing nickname
            const nicknameInput = document.getElementById('nickname');
            const nickname = nicknameInput ? nicknameInput.value.trim() : "";
            
            // Re-initialize TournamentManager
            console.log("Re-initializing TournamentManager with current elements");
            TournamentManager.init({
              createTournament: document.getElementById('create-tournament'),
              startTournament: document.getElementById('start-tournament'),
              leaveTournament: document.getElementById('leave-tournament'),
              tournamentName: document.getElementById('tournament-name'),
              tournamentPlayers: document.getElementById('tournament-players'),
              currentMatch: document.getElementById('current-match'),
              upcomingMatches: document.getElementById('upcoming-matches'),
              completedMatches: document.getElementById('completed-matches'),
              activeTournament: document.getElementById('active-tournament'),
              availableTournaments: document.getElementById('available-tournaments'),
              tournamentList: document.getElementById('tournament-list'),
              roundsInput: document.getElementById('rounds-input')
            }, nickname);
          }
        });
    </script>

</body>
</html>